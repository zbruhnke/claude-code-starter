name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          # Exclude info-level warnings (SC2034=unused var)
          shellcheck --severity=warning --exclude=SC2034 setup.sh adopt.sh review-mr.sh lib/common.sh
          shellcheck --severity=warning --exclude=SC2034 .claude/hooks/*.sh

  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            # jq for hooks, coreutils for gtimeout, bash for Bash 4+
            brew install jq coreutils bash || true
          fi

      - name: Set up Homebrew paths (macOS)
        if: runner.os == 'macOS'
        run: |
          # Detect Homebrew prefix (works on both Intel and ARM)
          BREW_PREFIX="$(brew --prefix)"
          echo "BREW_PREFIX=$BREW_PREFIX" >> $GITHUB_ENV
          echo "PATH=$BREW_PREFIX/bin:$PATH" >> $GITHUB_ENV

      - name: Check bash version
        run: |
          bash --version
          BASH_MAJOR=$(bash -c 'echo ${BASH_VERSINFO[0]}')
          echo "Using Bash $BASH_MAJOR.x"

      - name: Syntax check all scripts
        run: |
          for f in setup.sh adopt.sh review-mr.sh lib/common.sh .claude/hooks/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Test setup.sh in temp directory
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          git init

          # Set up commands based on OS
          TIMEOUT_CMD="timeout"
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            TIMEOUT_CMD="${BREW_PREFIX}/bin/gtimeout"
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi

          # Run setup non-interactively - capture exit code properly
          set +e
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | TERM=dumb $TIMEOUT_CMD 30 $BASH_CMD "$GITHUB_WORKSPACE/setup.sh"
          EXIT_CODE=$?
          set -e

          # Handle exit codes
          if [ "$EXIT_CODE" -eq 124 ]; then
            echo "::error::setup.sh timed out after 30 seconds"
            exit 1
          elif [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::setup.sh failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify key files were created
          test -f CLAUDE.md || { echo "::error::CLAUDE.md not created"; exit 1; }
          echo "✓ CLAUDE.md created"
          test -d .claude || { echo "::error::.claude directory not created"; exit 1; }
          echo "✓ .claude directory created"
          test -f .claude/settings.json || { echo "::error::settings.json not created"; exit 1; }
          echo "✓ settings.json created"

      - name: Test setup.sh idempotency (run twice)
        run: |
          cd /tmp/test-project

          # Set up commands based on OS
          TIMEOUT_CMD="timeout"
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            TIMEOUT_CMD="${BREW_PREFIX}/bin/gtimeout"
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi

          # Run setup again - capture exit code properly
          set +e
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | TERM=dumb $TIMEOUT_CMD 30 $BASH_CMD "$GITHUB_WORKSPACE/setup.sh"
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -eq 124 ]; then
            echo "::error::setup.sh idempotency test timed out"
            exit 1
          elif [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::setup.sh idempotency test failed - second run should succeed"
            exit 1
          fi

          echo "✓ Idempotency test passed"

      - name: Test adopt.sh help
        run: |
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi
          $BASH_CMD ./adopt.sh --help

      - name: Test adopt.sh smoke test (skills component)
        run: |
          mkdir -p /tmp/adopt-test
          cd /tmp/adopt-test
          git init

          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi

          # Adopt skills component - capture exit code properly
          set +e
          $BASH_CMD "$GITHUB_WORKSPACE/adopt.sh" skills
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::adopt.sh skills failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify skills were copied with proper directory structure
          test -d .claude/skills || { echo "::error::skills directory not copied"; exit 1; }
          test -d .claude/skills/code-review || { echo "::error::code-review skill directory not created"; exit 1; }
          test -f .claude/skills/code-review/SKILL.md || { echo "::error::code-review SKILL.md not found"; exit 1; }
          echo "✓ adopt.sh skills test passed"

      - name: Test review-mr.sh help
        run: |
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi
          $BASH_CMD ./review-mr.sh --help

      - name: Test validate-bash.sh hook
        run: |
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASH_CMD="${BREW_PREFIX}/bin/bash"
          fi
          $BASH_CMD .claude/hooks/test-validate-bash.sh

  json-validate:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate all JSON files
        run: |
          for f in .claude/settings.json stacks/*/settings.json; do
            echo "Validating $f..."
            jq . "$f" > /dev/null
          done
          echo "✓ All JSON files valid"
