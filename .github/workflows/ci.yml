name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          # Exclude info-level warnings (SC2034=unused var)
          shellcheck --severity=warning --exclude=SC2034 setup.sh adopt.sh review-mr.sh lib/common.sh
          shellcheck --severity=warning --exclude=SC2034 .claude/hooks/*.sh

  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get install -y jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            # jq for hooks, coreutils for gtimeout, bash for Bash 4+
            brew install jq coreutils bash || true
          fi

      - name: Check bash version
        run: |
          # On macOS, use Homebrew bash (4+) instead of system bash (3.2)
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export PATH="/opt/homebrew/bin:$PATH"
          fi
          bash --version
          BASH_MAJOR=$(bash -c 'echo ${BASH_VERSINFO[0]}')
          echo "Using Bash $BASH_MAJOR.x"

      - name: Syntax check all scripts
        run: |
          for f in setup.sh adopt.sh review-mr.sh lib/common.sh .claude/hooks/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Test setup.sh in temp directory
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          git init

          # On macOS, use Homebrew tools (bash 4+, gtimeout)
          TIMEOUT_CMD="timeout"
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export PATH="/opt/homebrew/bin:$PATH"
            TIMEOUT_CMD="gtimeout"
            BASH_CMD="/opt/homebrew/bin/bash"
          fi

          # Run setup non-interactively by providing inputs
          # TERM=dumb allows clear/tput commands to work in CI
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | TERM=dumb $TIMEOUT_CMD 30 $BASH_CMD "$GITHUB_WORKSPACE/setup.sh" || EXIT_CODE=$?

          # Handle exit codes explicitly
          if [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo "::error::setup.sh timed out after 30 seconds"
            exit 1
          elif [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::error::setup.sh failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify key files were created
          test -f CLAUDE.md || { echo "::error::CLAUDE.md not created"; exit 1; }
          echo "✓ CLAUDE.md created"
          test -d .claude || { echo "::error::.claude directory not created"; exit 1; }
          echo "✓ .claude directory created"
          test -f .claude/settings.json || { echo "::error::settings.json not created"; exit 1; }
          echo "✓ settings.json created"

      - name: Test setup.sh idempotency (run twice)
        run: |
          cd /tmp/test-project

          # On macOS, use Homebrew tools (bash 4+, gtimeout)
          TIMEOUT_CMD="timeout"
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export PATH="/opt/homebrew/bin:$PATH"
            TIMEOUT_CMD="gtimeout"
            BASH_CMD="/opt/homebrew/bin/bash"
          fi

          # Run setup again - should not fail
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | TERM=dumb $TIMEOUT_CMD 30 $BASH_CMD "$GITHUB_WORKSPACE/setup.sh" || EXIT_CODE=$?

          if [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo "::error::setup.sh idempotency test timed out"
            exit 1
          elif [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::error::setup.sh idempotency test failed - second run should succeed"
            exit 1
          fi

          echo "✓ Idempotency test passed"

      - name: Test adopt.sh help
        run: |
          # On macOS, use Homebrew bash
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            /opt/homebrew/bin/bash ./adopt.sh --help
          else
            ./adopt.sh --help
          fi

      - name: Test adopt.sh smoke test (skills component)
        run: |
          mkdir -p /tmp/adopt-test
          cd /tmp/adopt-test
          git init

          # On macOS, use Homebrew bash
          BASH_CMD="bash"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BASH_CMD="/opt/homebrew/bin/bash"
          fi

          # Adopt skills component
          $BASH_CMD "$GITHUB_WORKSPACE/adopt.sh" skills || EXIT_CODE=$?

          if [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::error::adopt.sh skills failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify skills were copied
          test -d .claude/skills || { echo "::error::skills not copied"; exit 1; }
          echo "✓ adopt.sh skills test passed"

      - name: Test review-mr.sh help
        run: |
          # On macOS, use Homebrew bash
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            /opt/homebrew/bin/bash ./review-mr.sh --help
          else
            ./review-mr.sh --help
          fi

  json-validate:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate all JSON files
        run: |
          for f in .claude/settings.json stacks/*/settings.json; do
            echo "Validating $f..."
            jq . "$f" > /dev/null
          done
          echo "✓ All JSON files valid"
