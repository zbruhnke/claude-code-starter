name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          shellcheck setup.sh adopt.sh review-mr.sh lib/common.sh
          shellcheck .claude/hooks/*.sh

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq (required for hooks)
        run: sudo apt-get install -y jq

      - name: Check bash version
        run: bash --version

      - name: Syntax check all scripts
        run: |
          for f in setup.sh adopt.sh review-mr.sh lib/common.sh .claude/hooks/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Test setup.sh in temp directory
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          git init

          # Run setup non-interactively by providing inputs
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | timeout 30 "$GITHUB_WORKSPACE/setup.sh"
          EXIT_CODE=$?

          # Handle exit codes explicitly
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::error::setup.sh timed out after 30 seconds"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::error::setup.sh failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify key files were created
          test -f CLAUDE.md || { echo "::error::CLAUDE.md not created"; exit 1; }
          echo "✓ CLAUDE.md created"
          test -d .claude || { echo "::error::.claude directory not created"; exit 1; }
          echo "✓ .claude directory created"
          test -f .claude/settings.json || { echo "::error::settings.json not created"; exit 1; }
          echo "✓ settings.json created"

      - name: Test adopt.sh help
        run: ./adopt.sh --help

      - name: Test review-mr.sh help
        run: ./review-mr.sh --help

  json-validate:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate all JSON files
        run: |
          for f in .claude/settings.json stacks/*/settings.json; do
            echo "Validating $f..."
            jq . "$f" > /dev/null
          done
          echo "✓ All JSON files valid"
