name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Run the same checks as CI before releasing
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq

      - name: Run shellcheck
        run: |
          shellcheck --severity=warning --exclude=SC2034 setup.sh adopt.sh review-mr.sh lib/common.sh
          shellcheck --severity=warning --exclude=SC2034 .claude/hooks/*.sh

      - name: Syntax check all scripts
        run: |
          for f in setup.sh adopt.sh review-mr.sh lib/common.sh .claude/hooks/*.sh; do
            bash -n "$f"
          done

      - name: Validate JSON files
        run: |
          for f in .claude/settings.json .claude/core-settings.json stacks/*/stack-settings.json; do
            jq . "$f" > /dev/null
          done

      - name: Smoke test setup.sh
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          git init

          # Run setup non-interactively - capture exit code properly
          set +e
          echo -e "1\ntest-project\nA test project\nnpm run dev\nnpm test\nnpm run build\nnpm run lint\nnpx tsc --noEmit\ny\ny\ny\ny\nn\nn\n" | TERM=dumb timeout 30 bash "$GITHUB_WORKSPACE/setup.sh"
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -eq 124 ]; then
            echo "::error::setup.sh timed out"
            exit 1
          elif [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::setup.sh failed with exit code $EXIT_CODE"
            exit 1
          fi

          # Verify key files
          test -f CLAUDE.md || { echo "::error::CLAUDE.md not created"; exit 1; }
          test -f .claude/settings.json || { echo "::error::settings.json not created"; exit 1; }
          echo "âœ“ Smoke test passed"

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for release notes

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate checksums
        id: checksums
        run: |
          echo "Generating SHA256 checksums..."

          # Generate checksums for key files
          SETUP_SHA=$(sha256sum setup.sh | cut -d' ' -f1)
          ADOPT_SHA=$(sha256sum adopt.sh | cut -d' ' -f1)
          REVIEW_SHA=$(sha256sum review-mr.sh | cut -d' ' -f1)

          # Generate checksum for the release tarball (what install.sh downloads)
          # The tarball name follows GitHub's pattern: {repo}-{version-without-v}.tar.gz
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL_NAME="claude-code-starter-${VERSION#v}.tar.gz"

          # Download the tarball that GitHub auto-generates
          curl -fsSL "https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz" -o "$TARBALL_NAME"
          TARBALL_SHA=$(sha256sum "$TARBALL_NAME" | cut -d' ' -f1)

          # Create checksums.txt file (this is what ccs update looks for)
          cat > checksums.txt << EOF
          # SHA256 checksums for ${{ steps.version.outputs.version }}
          # Verify with: sha256sum -c checksums.txt (Linux) or shasum -a 256 -c checksums.txt (macOS)
          $TARBALL_SHA  $TARBALL_NAME
          $TARBALL_SHA  release.tar.gz
          $SETUP_SHA  setup.sh
          $ADOPT_SHA  adopt.sh
          $REVIEW_SHA  review-mr.sh
          EOF

          echo "checksums.txt contents:"
          cat checksums.txt

          # Output for use in release notes
          echo "setup_sha=$SETUP_SHA" >> $GITHUB_OUTPUT
          echo "adopt_sha=$ADOPT_SHA" >> $GITHUB_OUTPUT
          echo "review_sha=$REVIEW_SHA" >> $GITHUB_OUTPUT
          echo "tarball_sha=$TARBALL_SHA" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          # Get the previous tag (more robust method)
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${{ steps.version.outputs.version }}$" | head -n 1 || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating notes from $PREV_TAG to ${{ steps.version.outputs.version }}"
            COMMITS=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD)
          else
            echo "First release - using all commits"
            COMMITS=$(git log --pretty=format:"- %s")
          fi

          # Write to file to handle multiline
          cat > release_notes.md << 'NOTES_EOF'
          ## What's Changed

          NOTES_EOF

          echo "$COMMITS" >> release_notes.md

          cat >> release_notes.md << NOTES_EOF

          ## Installation

          \`\`\`bash
          # New project
          git clone https://github.com/${{ github.repository }}.git my-project
          cd my-project && ./setup.sh

          # Existing project (pinned to this release)
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ steps.version.outputs.version }}/setup.sh -o setup.sh
          less setup.sh && chmod +x setup.sh && ./setup.sh
          \`\`\`

          ## Checksums (SHA256)

          Verify downloaded scripts match these checksums:

          \`\`\`
          ${{ steps.checksums.outputs.setup_sha }}  setup.sh
          ${{ steps.checksums.outputs.adopt_sha }}  adopt.sh
          ${{ steps.checksums.outputs.review_sha }}  review-mr.sh
          \`\`\`

          Verify with:
          - Linux: \`echo "CHECKSUM  setup.sh" | sha256sum -c -\`
          - macOS: \`echo "CHECKSUM  setup.sh" | shasum -a 256 -c -\`

          ## Documentation

          See [README](https://github.com/${{ github.repository }}#readme) for full documentation.
          NOTES_EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          # Only mark as pre-release if version contains -alpha, -beta, -rc, etc.
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          # Upload checksums.txt as release asset (required for ccs update verification)
          files: checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
