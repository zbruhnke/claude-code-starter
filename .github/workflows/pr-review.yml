# Claude Code PR Review
# Automatically reviews pull requests using Claude
#
# Setup:
# 1. Copy this file to your repo: .github/workflows/pr-review.yml
# 2. Add ANTHROPIC_API_KEY to your repo secrets
# 3. PRs will automatically get AI reviews as comments
#
# Configuration:
# - Runs on PR open, synchronize (new commits), and reopened
# - Posts review as a comment on the PR
# - Can be triggered manually via workflow_dispatch
#

name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    name: Claude Review

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diffs

      - name: Get PR info
        id: pr
        run: |
          if [ -n "${{ github.event.inputs.pr_number }}" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get branch names
          if [ -n "${{ github.event.pull_request.head.ref }}" ]; then
            echo "head=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "base=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          else
            # Manual trigger - get from API
            gh pr view $PR_NUMBER --json headRefName,baseRefName \
              -q '"head=" + .headRefName + "\nbase=" + .baseRefName' >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch branches
        run: |
          git fetch origin ${{ steps.pr.outputs.head }}
          git fetch origin ${{ steps.pr.outputs.base }}

      - name: Generate diff context
        id: diff
        run: |
          BASE="${{ steps.pr.outputs.base }}"
          HEAD="${{ steps.pr.outputs.head }}"

          # Get stats
          FILES=$(git diff origin/$BASE...origin/$HEAD --name-only | wc -l)
          ADDITIONS=$(git diff origin/$BASE...origin/$HEAD --numstat | awk '{sum += $1} END {print sum+0}')
          DELETIONS=$(git diff origin/$BASE...origin/$HEAD --numstat | awk '{sum += $2} END {print sum+0}')

          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT

          # Get commits
          git log origin/$BASE..origin/$HEAD --oneline > commits.txt

          # Get diff (limit size for API)
          git diff origin/$BASE...origin/$HEAD > full_diff.txt
          head -c 100000 full_diff.txt > diff.txt

          if [ $(wc -c < full_diff.txt) -gt 100000 ]; then
            echo "" >> diff.txt
            echo "... (diff truncated, $(wc -c < full_diff.txt) bytes total)" >> diff.txt
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMITS=$(cat commits.txt)
          DIFF=$(cat diff.txt)

          PROMPT="You are reviewing a pull request.

          Branch: ${{ steps.pr.outputs.head }} â†’ ${{ steps.pr.outputs.base }}
          Files changed: ${{ steps.diff.outputs.files }}
          Lines: +${{ steps.diff.outputs.additions }} / -${{ steps.diff.outputs.deletions }}

          Commits:
          $COMMITS

          Provide a concise, actionable review. Be specific about issues and suggestions.
          Format your response as clean markdown suitable for a PR comment.

          Structure:
          ## Summary
          (2-3 sentences)

          ## Key Changes
          - Bullet points of main changes

          ## Review

          ### Issues Found
          (If any - be specific with file:line references)

          ### Suggestions
          (Specific improvements)

          ## Verdict
          ðŸŸ¢ Ready to merge | ðŸŸ¡ Minor changes needed | ðŸ”´ Needs work

          Diff:
          \`\`\`diff
          $DIFF
          \`\`\`"

          # Run Claude and capture output
          REVIEW=$(echo "$PROMPT" | claude --print 2>&1 || echo "Review generation failed")

          # Save to file (handles multiline)
          echo "$REVIEW" > review.md

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');

            const prNumber = ${{ steps.pr.outputs.number }};

            // Check for existing bot comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('<!-- claude-review -->')
            );

            const body = `<!-- claude-review -->
            # ðŸ¤– Claude Review

            ${review}

            ---
            <sub>Generated by [Claude Code Starter](https://github.com/zbruhnke/claude-code-starter) â€¢ [Re-run review](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/pr-review.yml)</sub>
            `;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
