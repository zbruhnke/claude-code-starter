# Weekly Code Quality Check
# Runs Claude to review specific directories and suggest improvements
#
# Setup:
# 1. Add ANTHROPIC_API_KEY to repository secrets
# 2. Customize directories to review in the DIRECTORIES variable
# 3. Adjust schedule if needed (default: Sunday midnight UTC)

name: Code Quality

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: Quality Review

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run quality review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Directories to review (customize per project)
          DIRECTORIES=".claude/skills .claude/hooks .claude/agents"

          # Build file list
          FILES=""
          for dir in $DIRECTORIES; do
            if [ -d "$dir" ]; then
              FILES="$FILES $(find $dir -type f -name '*.md' -o -name '*.sh' -o -name '*.js' -o -name '*.json' 2>/dev/null | head -20)"
            fi
          done

          if [ -z "$FILES" ]; then
            echo "No files to review"
            echo "has_suggestions=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PROMPT="Review these files for quality improvements:

          Files:
          $(for f in $FILES; do echo "=== $f ==="; head -100 "$f" 2>/dev/null; echo; done)

          Provide specific, actionable suggestions:

          ## Quality Issues Found

          For each issue:
          - **File**: path/to/file
          - **Issue**: What's wrong
          - **Suggestion**: How to fix it

          Focus on:
          1. Code clarity and readability
          2. Potential bugs or edge cases
          3. Security concerns
          4. Documentation gaps
          5. Consistency with project patterns

          Keep suggestions practical and specific.
          If no significant issues found, say so briefly."

          REVIEW=$(echo "$PROMPT" | claude --print 2>&1 || echo "Quality review failed")

          # Check if there are meaningful suggestions
          if echo "$REVIEW" | grep -qi "no significant issues\|no issues found\|looks good\|quality is good"; then
            echo "has_suggestions=false" >> $GITHUB_OUTPUT
          else
            echo "has_suggestions=true" >> $GITHUB_OUTPUT
          fi

          echo "$REVIEW" > quality-report.md

      - name: Create issue if suggestions found
        if: steps.review.outputs.has_suggestions == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');

            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Code Quality Report - ${today}`,
              body: `# üîç Automated Quality Review

            ${report}

            ---
            <sub>Generated by weekly [Code Quality](.github/workflows/code-quality.yml) workflow</sub>
            `,
              labels: ['code-quality', 'automated']
            });
