# Biweekly Dependency Audit
# Uses Claude to analyze and suggest dependency updates
#
# Setup:
# 1. Add ANTHROPIC_API_KEY to repository secrets
# 2. Adjust schedule if needed (default: 1st and 15th of month)
#
# This workflow:
# - Checks for outdated dependencies
# - Reviews security vulnerabilities
# - Opens issues for significant updates

name: Dependency Audit

on:
  schedule:
    - cron: '0 0 1,15 * *'  # 1st and 15th of each month
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    name: Dependency Review

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for package files
        id: packages
        run: |
          HAS_NPM=false
          HAS_PIP=false

          if [ -f "package.json" ]; then
            HAS_NPM=true
          fi

          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            HAS_PIP=true
          fi

          echo "has_npm=$HAS_NPM" >> $GITHUB_OUTPUT
          echo "has_pip=$HAS_PIP" >> $GITHUB_OUTPUT

          if [ "$HAS_NPM" = "false" ] && [ "$HAS_PIP" = "false" ]; then
            echo "No dependency files found"
            echo "has_deps=false" >> $GITHUB_OUTPUT
          else
            echo "has_deps=true" >> $GITHUB_OUTPUT
          fi

      - name: NPM Audit
        if: steps.packages.outputs.has_npm == 'true'
        id: npm_audit
        run: |
          npm audit --json > npm-audit.json 2>&1 || true
          npm outdated --json > npm-outdated.json 2>&1 || true

      - name: Install Claude CLI
        if: steps.packages.outputs.has_deps == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze dependencies
        if: steps.packages.outputs.has_deps == 'true'
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Gather context
          CONTEXT=""

          if [ -f "npm-audit.json" ]; then
            CONTEXT="$CONTEXT

          ## NPM Audit Results
          $(cat npm-audit.json | head -c 5000)"
          fi

          if [ -f "npm-outdated.json" ]; then
            CONTEXT="$CONTEXT

          ## Outdated NPM Packages
          $(cat npm-outdated.json | head -c 5000)"
          fi

          if [ -f "package.json" ]; then
            CONTEXT="$CONTEXT

          ## package.json
          $(cat package.json | head -c 3000)"
          fi

          if [ -z "$CONTEXT" ]; then
            echo "has_issues=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PROMPT="Analyze these dependency reports and provide recommendations:
          $CONTEXT

          Provide a structured report:

          ## Security Issues
          List any vulnerabilities with severity (critical, high, medium, low)

          ## Recommended Updates
          List safe updates that should be applied, prioritized by importance

          ## Breaking Changes Warning
          Note any major version updates that may require code changes

          ## Action Items
          1. [Specific action with command]
          2. [Next action]

          Keep it concise and actionable."

          REPORT=$(echo "$PROMPT" | claude --print 2>&1 || echo "Analysis failed")

          # Check for meaningful findings
          if echo "$REPORT" | grep -qi "no security issues\|no vulnerabilities\|all up to date\|no updates"; then
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

          echo "$REPORT" > dependency-report.md

      - name: Create issue if issues found
        if: steps.analyze.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');

            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Dependency Audit Report - ${today}`,
              body: `# ðŸ“¦ Automated Dependency Audit

            ${report}

            ---
            <sub>Generated by [Dependency Audit](.github/workflows/dependency-audit.yml) workflow</sub>
            `,
              labels: ['dependencies', 'security', 'automated']
            });
